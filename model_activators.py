"""
Reproducibility Study of “Studying How to Efficiently and Effectively Guide Models with Explanations”

Description: This file is part of a project aiming to reproduce the study titled "Studying How to Efficiently and 
Effectively Guide Models with Explanations." The project focuses on verifying the results and methodologies 
proposed in the original study, and potentially extending or refining the study's findings.

Based on the code of orginal paper: https://github.com/sukrutrao/Model-Guidance

model_activators.py
"""

import torch


class ResNetModelActivator(torch.nn.Module):
    def __init__(self, model, layer=None, is_bcos=False):
        super().__init__()
        self.model = model
        self.layer = layer
        self.is_bcos = is_bcos
        if self.layer is not None:
            if self.is_bcos:
                self.layer_list = list(self.model[0].named_children())
            else:
                self.layer_list = list(self.model.named_children())
            assert self.layer >= 0 and self.layer < len(self.layer_list) - 1

    def __call__(self, img):
        if self.layer is None:
            output = self.model(img)
            feature = img
        else:
            acts = img
            if not self.is_bcos:
                for lidx in range(len(self.layer_list) - 1):
                    acts = self.layer_list[lidx][1](acts)
                    if lidx == self.layer:
                        feature = acts
                acts = acts.flatten(1)
                output = self.layer_list[-1][1](acts)
            else:
                for lidx in range(len(self.layer_list) - 2):
                    acts = self.layer_list[lidx][1](acts)
                    if lidx == self.layer:
                        feature = acts
                acts = self.layer_list[-1][1](acts)
                output = self.layer_list[-2][1](acts)
                output = self.model[1](output)
                output = output.flatten(1)
        return output, feature
